#!/bin/bash

# 编译 blip_buf 为 WASM (WASI 支持)
# 使用方法: ./build_wasm.sh

set -e

# 脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# 输出文件名
OUTPUT="blip_buf.wasm"
INL_OUTPUT="blip_buf.inl"

# 检查 emcc 是否可用
if ! command -v emcc &> /dev/null; then
    echo "错误: 找不到 emcc 命令"
    echo "请确保已安装 Emscripten SDK 并激活环境"
    echo "安装方法: https://emscripten.org/docs/getting_started/downloads.html"
    exit 1
fi

echo "开始编译 $OUTPUT ..."

# 使用 emcc 编译
emcc \
    blip_buf.c \
    blip_wasm_wrapper.c \
    -o "$OUTPUT" \
    -sSTANDALONE_WASM=1 \
    -sEXPORTED_FUNCTIONS='["_bb_malloc", "_bb_new","_bb_delete","_bb_set_rates","_bb_clear","_bb_clocks_needed","_bb_end_frame","_bb_samples_avail","_bb_read_samples","_bb_add_delta","_bb_add_delta_fast"]' \
    -sEXPORTED_RUNTIME_METHODS='[]' \
    -sALLOW_MEMORY_GROWTH=1 \
    -sABORTING_MALLOC=0 \
    -sPURE_WASI=1 \
    --no-entry \
    -Wall \
    -Wextra \
    -O2

echo "编译完成: $OUTPUT"
ORIGINAL_SIZE=$(wc -c < "$OUTPUT" | tr -d ' ')
echo "文件大小: $(ls -lh "$OUTPUT" | awk '{print $5}')"

# 转换为字节数组文件
echo "生成字节数组文件: $INL_OUTPUT ..."

if command -v xxd &> /dev/null; then
    # 使用 xxd 生成 C 风格的字节数组
    # xxd -i 会将文件名中的点替换为下划线，所以 blip_buf.wasm -> blip_buf_wasm
    xxd -i "$OUTPUT" > "$INL_OUTPUT.tmp"
    # 添加 const 修饰符和头文件保护
    {
        echo "// Auto-generated from $OUTPUT"
        echo "// DO NOT EDIT THIS FILE MANUALLY"
        echo ""
        echo "#ifndef BLIP_BUF_WASM_INL_H"
        echo "#define BLIP_BUF_WASM_INL_H"
        echo ""
        # 将 unsigned char 替换为 const unsigned char，unsigned int 替换为 const unsigned int
        sed 's/^unsigned char /static const unsigned char /' "$INL_OUTPUT.tmp" | \
            sed 's/^unsigned int /static const unsigned int /'
        echo ""
        echo "#endif // BLIP_BUF_WASM_INL_H"
    } > "$INL_OUTPUT"
    rm -f "$INL_OUTPUT.tmp"
else
    # 如果没有 xxd，使用 hexdump 生成
    WASM_SIZE=$(wc -c < "$OUTPUT" | tr -d ' ')
    {
        echo "// Auto-generated from $OUTPUT"
        echo "// DO NOT EDIT THIS FILE MANUALLY"
        echo ""
        echo "#ifndef BLIP_BUF_WASM_INL_H"
        echo "#define BLIP_BUF_WASM_INL_H"
        echo ""
        echo "static const unsigned char blip_buf_wasm[] = {"
        # 每行最多 16 个字节，格式化为 0xXX, 0xXX, ...
        hexdump -v -e '16/1 "0x%02x," "\n"' "$OUTPUT" | \
            sed 's/,$//' | \
            sed 's/^/    /' | \
            sed '$!s/$/,/'
        echo "};"
        echo ""
        echo "static const unsigned int blip_buf_wasm_len = $WASM_SIZE;"
        echo ""
        echo "#endif // BLIP_BUF_WASM_INL_H"
    } > "$INL_OUTPUT"
fi

echo "字节数组文件生成完成: $INL_OUTPUT"
echo "字节数组大小: $(wc -c < "$OUTPUT" | tr -d ' ') 字节"
